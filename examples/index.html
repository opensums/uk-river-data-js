<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />
    <style>
      .template {
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="app" class="container">
      <noscript>This example page requires JavaScript.</noscript>
    </div>

    <!-- Load Vue 3 to run examples. -->
    <script src="https://unpkg.com/vue@3"></script>

    <!-- Load Chart.js and its dependencies for time series charts. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2/dist/Chart.bundle.js"></script>

    <!-- Axios is a dependency and must be loaded before UK River Data. -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script src="../dist/uk-river-data.min.js"></script>

    <!-- Vue application template -->
    <div class="template" id="app-template">
      <div>
        <button class="btn btn-secondary" @click="loadLatest">
          Load latest data
        </button>
        <button class="btn btn-secondary" @click="loadCurrent">
          Load current data
        </button>
        <button class="btn btn-secondary" @click="loadLatestFlow">
          Load latest flow readings
        </button>

        <canvas ref="chartCanvas" style="height: 400px"></canvas>

        <div v-if="station && station.latest">
          <h3>Latest</h3>
          <p>
            Level {{ station.latest.level[1] }} @{{ station.latest.level[0] }}
          </p>
          <p>Flow {{ station.latest.flow[1] }} @{{ station.latest.flow[0] }}</p>
        </div>

        <h3>Flow</h3>
        <ul class="list-group">
          <li v-for="[time, value] in flow" class="list-group-item">
            {{ time }} {{ value }}
          </li>
        </ul>
        <h3>Level</h3>
        <ul class="list-group">
          <li v-for="[time, value] in level" class="list-group-item">
            {{ time }} {{ value }}
          </li>
        </ul>
      </div>
      <p>Version {{ version }}</p>

      <h3>Station</h3>
      <pre>{{ station }}</pre>

      <h3>Readings</h3>
      <pre>{{ readings }}</pre>

      <!-- Acknowledgements -->
      <footer class="footer bg-light">
        <small>
          Data provided by the
          <a href="https://environment.data.gov.uk/" target="_blank"
            >DEFRA Data Services Platform</a
          >
          and published under the
          <a
            href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
            target="_blank"
            >Open Government License</a
          >.
        </small>
      </footer>
    </div>

    <!-- Vue application -->
    <script>
      const { createReadings, createStation } = UkRiverData;
      Vue.createApp({
        template: '#app-template',
        data() {
          return {
            chartIsLoaded: false,
            stationReference: '3400TH',
            version: UkRiverData.version,
            readings: null,
            station: null,
          };
        },
        computed: {
          // Convert UKRiversData object to Chart.js x-y chart input.
          chartData() {
            return Object.entries(this.station.readings).reduce(
              (data, [label, seriesData]) => {
                data[label] = {
                  data: seriesData.map(([dateTime, value]) => ({
                    x: new Date(dateTime),
                    y: value,
                  })),
                };
                return data;
              },
              {}
            );
          },
        },

        mounted() {
          if (this.stationReference) {
            this.station = createStation(this.stationReference);
          }
        },

        methods: {
          async loadCurrent() {
            await this.station.getSince();
            this.loadChart();
          },

          async loadLatest() {
            return this.station.getLatest();
          },

          async loadLatestFlow() {
            this.readings = await createReadings({
              stationReference: '3400TH',
            });
            this.readings.getLatest();
          },

          loadChart() {
            if (this.chartIsLoaded) {
              // Refresh.
              return;
            }
            const data = this.chartData;

            this.chart = new Chart(this.$refs.chartCanvas.getContext('2d'), {
              type: 'scatter',
              data: {
                datasets: [
                  {
                    label: 'Level',
                    yAxisID: 'level',
                    data: this.chartData.level.data,
                    showLine: true,
                    borderWidth: 1,
                  },
                  {
                    label: 'Flow',
                    yAxisID: 'flow',
                    data: this.chartData.flow.data,
                    showLine: true,
                    borderColor: 'green',
                    borderWidth: 1,
                    fill: false,
                  },
                ],
              },
              options: {
                scales: {
                  xAxes: [
                    {
                      type: 'time',
                      time: {},
                    },
                  ],
                  yAxes: [
                    {
                      id: 'flow',
                      type: 'linear',
                      position: 'left',
                    },
                    {
                      id: 'level',
                      type: 'linear',
                      position: 'right',
                    },
                  ],
                },
              },
            });
            this.chartIsLoaded = true;
          },
        },
      }).mount('#app');
    </script>
  </body>
</html>
